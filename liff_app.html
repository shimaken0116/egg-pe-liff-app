<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROGRAM EGG 申込フォームへ</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding-top: 50px; }
        #status { font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
    </style>
</head>
<body>
    <h1>申込フォームへ移動中...</h1>
    <p>ステータス: <span id="status">LIFFを初期化中...</span></p>

    <!-- LIFF SDK -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

    <script>
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ ここに、LINE Developersから取得したLIFF IDを貼り付けてください ★
        const LIFF_ID = "2007669947-nZxWXAbN"; 
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★
        // ★ ここに、Googleフォームの事前入力用URLのベースを貼り付けてください ★
        // ★ 例: https://docs.google.com/forms/d/e/1FAIpQLScVoQqGe-akSvFiKtg6CcPFGLO06GSu4naiwFSIL5HjOi3cBw/viewform?usp=pp_url&entry.2044946577= 
        const GOOGLE_FORM_BASE_URL = "https://docs.google.com/forms/d/e/1FAIpQLScVoQqGe-akSvFiKtg6CcPFGLO06GSu4naiwFSIL5HjOi3cBw/viewform?usp=pp_url&entry.2044946577=";
        // ★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★★

        async function main() {
            try {
                // 1. LIFFの初期化
                setStatus("LIFFを初期化中...");
                await liff.init({ liffId: LIFF_ID });

                // 2. ログイン判定
                if (!liff.isLoggedIn()) {
                    setStatus("ログインしていません。ログインページに移動します。");
                    liff.login();
                    return;
                }

                // 3. IDトークンの取得とユーザーIDの抽出
                setStatus("ユーザー情報を取得中...");
                const idToken = liff.getIDToken();
                if (!idToken) {
                    throw new Error("IDトークンが取得できませんでした。");
                }

                // IDトークンからユーザーIDを抽出（GASを介さずLIFF側で直接行う）
                // LIFF SDKのliff.getProfile()でも取得可能だが、IDトークンから直接抽出する方がシンプル
                const decodedIdToken = parseJwt(idToken);
                const userId = decodedIdToken.sub; // 'sub' クレームにユーザーIDが含まれる

                if (!userId) {
                    throw new Error("ユーザーIDがIDトークンから取得できませんでした。");
                }

                // 4. GoogleフォームのURLを生成し、リダイレクト
                setStatus("Googleフォームへ移動します...");
                const formUrl = GOOGLE_FORM_BASE_URL + encodeURIComponent(userId);
                liff.openWindow({
                    url: formUrl,
                    external: true // 外部ブラウザで開く
                });

                // LIFFアプリは閉じる
                liff.closeWindow();

            } catch (error) {
                console.error(error);
                setStatus(`エラーが発生しました: ${error.message}`, "error");
                document.querySelector('h1').textContent = "エラー";
            }
        }

        // JWT（IDトークン）をデコードするヘルパー関数
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) {
                return null;
            }
        }

        function setStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = type; // 'success' or 'error'
        }

        // 処理を開始
        main();
    </script>
</body>
</html>
