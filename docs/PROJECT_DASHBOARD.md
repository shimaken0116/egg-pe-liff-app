# プロジェクトダッシュボード：LINEリマインド自動化システム

## 1. プロジェクト概要
LINE LiffとGoogleフォームを連携させ、会員へのリマインドメッセージ送信を自動化するシステム。

## 2. 現在の作業フォーカス
**会員向けLINEメッセージ送信システムの構築とパーソナライズ化**

## 3. 主要コンポーネントと関連ファイル
- **LINE LIFFアプリ**: `liff_app.html`
  - ユーザーIDの取得とGoogleフォームへのリダイレクトを担当。
- **Google Apps Script (GAS)**: `src/gas/onFormSubmit.js`, `src/gas/firestore_test.js`
  - Googleフォームの送信トリガーで実行され、LINEメッセージ送信とFirestoreへのデータ保存を担当。
- **Googleフォーム**: ユーザーからの情報収集インターフェース。
- **Googleスプレッドシート**: フォーム回答の一次データストア。
- **Firestore**: フォーム回答の永続的なデータストア。

## 4. 最近の進捗
- `src/gas/onFormSubmit_debug.js` を `src/gas/onFormSubmit.js` にリネーム。
- `src/gas/onFormSubmit.js` を改修し、フォーム回答から氏名と参加希望レッスンを取得してLINEメッセージに反映するようにパーソナライズ化。
- 複数選択されたレッスン名もメッセージに含めるように対応。
- Firestoreへのフォームデータ保存機能が実装済み。

## 5. 今後の課題と次のステップ

### フェーズ1: LINEメッセージ送信機能の動作確認

1.  **GASスクリプトのデプロイ完了確認**:
    *   ユーザーが`src/gas/onFormSubmit.js`の変更をGoogle Apps Scriptプロジェクトにデプロイしたことを確認します。

2.  **システムテストの実施**:
    *   ユーザーに、実際にLINE LIFFアプリからGoogleフォームを開き、必要事項（氏名、参加希望レッスンなど）を入力してフォームを送信してもらうよう依頼します。
    *   送信後、自身のLINEアカウントにパーソナライズされたメッセージが届くかを確認してもらいます。

3.  **ログの確認とデバッグ（必要に応じて）**:
    *   メッセージが届かない、または内容が期待通りでない場合、Google Apps Scriptの実行ログ（Stackdriver LoggingまたはGASエディタの「実行ログ」）を確認し、エラーや警告がないか調査します。
    *   Firestoreにデータが正しく保存されているかも確認します。

### フェーズ2: セキュリティ課題の解決

1.  **セキュリティ課題の再確認**:
    *   現在のLIFFアプリがクライアントサイドでIDトークンをデコードし、ユーザーIDをURLパラメータでGoogleフォームに渡しているという、`evaluation_report.md`で指摘されたセキュリティ上の脆弱性を改めてユーザーに説明します。

2.  **セキュアなアーキテクチャへの移行計画**:
    *   `evaluation_report.md`で推奨されている「**LIFFアプリからGASのWeb AppにIDトークンを送信し、GAS側で検証する**」アーキテクチャへの移行を提案します。
    *   具体的な変更点として、`liff_app.html`の修正と、GAS側にIDトークン検証用のWeb App（`doPost`関数）の実装が必要であることを説明します。

### フェーズ3: その他の改善と拡張

1.  **Firestoreセキュリティルールの強化**:
    *   テストが完了し、システムが安定稼働する目処が立ったら、Firestoreのセキュリティルールを「テストモード」から本番運用に適したルールに強化する計画を立てます。

2.  **LINEメッセージ送信機能の拡張**:
    *   リマインドメッセージのスケジュール送信機能（例: レッスン前日に自動送信）の検討。
    *   メッセージ内容のテンプレート化や管理機能の検討。
